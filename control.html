<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صفحة التحكم بالعيادة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="bg-gray-50 p-8">

    <div id="authScreen" class="max-w-md mx-auto bg-white p-6 rounded-xl shadow-lg mt-20">
        <h2 class="text-3xl font-bold text-center text-blue-700 mb-6">الدخول لعيادة</h2>
        <select id="clinicAuthSelect" class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-lg">
            <option value="">-- اختر العيادة --</option>
            </select>
        <input type="password" id="clinicPasswordAuth" placeholder="كلمة مرور العيادة" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">
        <button id="loginBtn" class="mt-4 w-full bg-blue-600 text-white p-3 rounded-lg text-xl hover:bg-blue-700 transition">دخول</button>
        <p id="authError" class="text-red-500 text-center mt-3 hidden">بيانات الدخول غير صحيحة.</p>
    </div>

    <div id="controlPanel" class="hidden max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg text-center">
        <h1 class="text-4xl font-extrabold text-blue-800 mb-2">لوحة تحكم <span id="currentClinicName" class="text-red-600"></span></h1>
        <p class="text-xl text-gray-600 mb-6">العميل الحالي: <span id="currentNumberDisplay" class="font-black text-4xl text-red-700">0</span></p>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="nextBtn" class="bg-green-600 text-white p-4 rounded-xl text-2xl font-bold hover:bg-green-700 transition shadow-lg">العميل التالي (نداء)</button>
            <button id="repeatBtn" class="bg-yellow-600 text-white p-4 rounded-xl text-2xl font-bold hover:bg-yellow-700 transition shadow-lg">تكرار النداء</button>
        </div>

        <div class="grid grid-cols-3 gap-3 mb-6">
            <button id="prevBtn" class="bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition">العميل السابق</button>
            <button onclick="resetClinic()" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition">تصفير العيادة</button>
            
            <button id="toggleStatusBtn" onclick="toggleClinicStatus()" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition">إيقاف العيادة</button>
        </div>
        
        <div class="bg-gray-100 p-4 rounded-lg mb-6">
            <h3 class="text-xl font-semibold mb-3">نداء مخصص</h3>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input type="number" id="specificNumberInput" placeholder="نداء رقم عميل معين" class="p-2 border rounded-md">
                <button onclick="callSpecificNumber()" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">نداء رقم</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="emergencyTextInput" placeholder="نص نداء الطوارئ/اسم عميل" class="p-2 border rounded-md">
                <button onclick="callEmergency()" class="bg-red-700 text-white p-2 rounded-lg hover:bg-red-800 transition">نداء للطوارئ/اسم</button>
            </div>
        </div>

        <div class="flex justify-between items-center bg-gray-200 p-3 rounded-lg">
            <button id="logoutBtn" onclick="location.reload()" class="bg-gray-600 text-white p-2 rounded-lg hover:bg-gray-700 transition">الخروج إلى الرئيسية</button>
            <button id="muteToggle" class="text-gray-600 hover:text-red-600 p-2 rounded-lg focus:outline-none">
                <span id="muteStatusText">تفعيل النطق</span>
            </button>
        </div>

    </div>

    <script src="js/script.js"></script>
    
    <script>
        let clinicsData = {};
        let currentClinicId = null;
        let currentClinicPass = '';
        let isMutedControl = false; // كتم الصوت خاص بصفحة التحكم فقط

        // ==========================================================
        // وظائف المصادقة
        // ==========================================================
        db.ref('clinics').on('value', snapshot => {
            clinicsData = snapshot.val() || {};
            const selectEl = document.getElementById('clinicAuthSelect');
            selectEl.innerHTML = '<option value="">-- اختر العيادة --</option>';
            Object.keys(clinicsData).forEach(id => {
                const clinic = clinicsData[id];
                selectEl.innerHTML += `<option value="${id}">${clinic.name} (${id})</option>`;
            });

            // تحديث حالة الشاشة إذا كان المستخدم مسجلاً الدخول
            if (currentClinicId) {
                updateControlPanel(clinicsData[currentClinicId]);
            }
        });
        
        document.getElementById('loginBtn').addEventListener('click', () => {
            const id = document.getElementById('clinicAuthSelect').value;
            const password = document.getElementById('clinicPasswordAuth').value;
            
            if (!id || !password || !clinicsData[id] || clinicsData[id].password !== password) {
                document.getElementById('authError').classList.remove('hidden');
                return;
            }

            currentClinicId = id;
            currentClinicPass = password;
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('controlPanel').classList.remove('hidden');
            updateControlPanel(clinicsData[id]);
        });
        
        function updateControlPanel(clinic) {
            if (!clinic) return;
            document.getElementById('currentClinicName').textContent = clinic.name;
            document.getElementById('currentNumberDisplay').textContent = clinic.currentNumber;

            // تحديث زر الحالة
            const statusBtn = document.getElementById('toggleStatusBtn');
            if (clinic.status === 'active') {
                statusBtn.textContent = 'إيقاف العيادة';
                statusBtn.classList.replace('bg-green-500', 'bg-indigo-500');
            } else {
                statusBtn.textContent = 'استئناف العيادة';
                statusBtn.classList.replace('bg-indigo-500', 'bg-green-500');
            }
        }

        // ==========================================================
        // وظائف التحكم في الأرقام والحالة
        // ==========================================================
        
        document.getElementById('nextBtn').addEventListener('click', () => {
            if (!currentClinicId) return;
            const clinicRef = db.ref(`clinics/${currentClinicId}`);
            clinicRef.once('value').then(snapshot => {
                const currentTicket = snapshot.val().ticketCounter + 1;
                // تحديث كلاً من العداد ورقم النداء الحالي
                clinicRef.update({
                    currentNumber: currentTicket,
                    ticketCounter: currentTicket
                }).then(() => {
                    // إرسال طلب نداء عبر دالة callNumber المشتركة
                    if (!isMutedControl) {
                        window.callNumber(parseInt(currentClinicId), currentTicket, 'normal');
                    }
                });
            });
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
             if (!currentClinicId) return;
             const currentNum = clinicsData[currentClinicId].currentNumber;
             if (currentNum > 1) {
                 db.ref(`clinics/${currentClinicId}`).update({
                     currentNumber: currentNum - 1
                 }).then(() => {
                    alert('تم الرجوع للعميل السابق (تحديث الشاشة الرئيسية).');
                 });
             }
        });

        document.getElementById('repeatBtn').addEventListener('click', () => {
             if (!currentClinicId) return;
             const currentNum = clinicsData[currentClinicId].currentNumber;
             if (currentNum > 0 && !isMutedControl) {
                 window.callNumber(parseInt(currentClinicId), currentNum, 'normal');
             }
        });

        function resetClinic() {
            if (!currentClinicId || !confirm('هل أنت متأكد من تصفير رقم العيادة؟')) return;
            db.ref(`clinics/${currentClinicId}`).update({
                 currentNumber: 0,
                 ticketCounter: 0
            }).then(() => alert('تم تصفير العيادة بنجاح.'));
        }

        function toggleClinicStatus() {
            if (!currentClinicId) return;
            const newStatus = clinicsData[currentClinicId].status === 'active' ? 'inactive' : 'active';
            db.ref(`clinics/${currentClinicId}`).update({
                 status: newStatus
            }).then(() => alert(`تم ${newStatus === 'active' ? 'استئناف' : 'إيقاف'} العيادة.`));
        }

        // ==========================================================
        // وظائف النداء المخصص
        // ==========================================================

        function callSpecificNumber() {
            const number = parseInt(document.getElementById('specificNumberInput').value);
             if (!currentClinicId || isNaN(number) || number <= 0) {
                alert('الرجاء إدخال رقم صحيح للنداء.');
                return;
            }
            // تحديث الرقم الحالي وإرسال نداء
            db.ref(`clinics/${currentClinicId}`).update({ currentNumber: number }).then(() => {
                if (!isMutedControl) {
                    window.callNumber(parseInt(currentClinicId), number, 'normal');
                }
            });
        }
        
        function callEmergency() {
            const text = document.getElementById('emergencyTextInput').value || "نداء طوارئ، يرجى الحضور فوراً!";
            // النداء باسم يستخدم type='name' والطوارئ يستخدم type='emergency'
            const type = text.includes('طوارئ') ? 'emergency' : 'name';
            
            if (!isMutedControl) {
                // نستخدم رقم العيادة الحالي كـ ID للعرض
                window.callNumber(parseInt(currentClinicId), 0, type, text); 
            }
        }
        
        // ==========================================================
        // وظائف كتم الصوت
        // ==========================================================
        document.getElementById('muteToggle').addEventListener('click', () => {
            isMutedControl = !isMutedControl;
            document.getElementById('muteStatusText').textContent = isMutedControl ? 'تفعيل النطق' : 'إيقاف النطق';
            alert(isMutedControl ? "تم كتم صوت التنبيهات في هذه الشاشة." : "تم تفعيل صوت التنبيهات في هذه الشاشة.");
        });
    </script>
</body>
</html>
